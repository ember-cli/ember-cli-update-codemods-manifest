language: node_js
node_js:
- '10'
- node
branches:
  only:
  - master
  # npm version tags
  - /^(?:[a-z-]+|@[a-z-]+\/[a-z-]+)@\d+\.\d+\.\d+$/
env:
  global:
  - DEBUG=ember-cli-update,boilerplate-update,git-diff-apply,git-fixtures
cache:
  npm: false
stages:
  - lint
  - test
  - ember-cli-update
  - deploy
before_install:
- curl -L https://unpkg.com/@pnpm/self-installer | node
install:
- pnpm install
jobs:
  allow_failures:
  - os: osx
  include:
  - stage: lint
    script:
    - npm run lint:git
    - npm run lint:js
  - stage: test
    env:
    - TEST_TYPE=addon
  - os: osx
  - stage: ember-cli-update
    if: branch = master AND type = pull_request
    script:
    - git checkout $TRAVIS_PULL_REQUEST_SHA
    - git checkout -B $TRAVIS_PULL_REQUEST_BRANCH
    - git remote set-url origin https://$GITHUB_TOKEN@github.com/$TRAVIS_PULL_REQUEST_SLUG.git
    - >
      npx https://github.com/kellyselden/ember-cli-update-action.git#semver:^1.3.11
      --pull-request-url https://api.github.com/repos/$TRAVIS_REPO_SLUG/pulls/$TRAVIS_PULL_REQUEST
      --autofix-command "npm run lint:js -- --fix"
      --commit-prefix "chore: "
  - stage: deploy
    if: branch = master AND tag IS blank AND type = push
    script:
    - git checkout -B master
    - git config user.email "travis@travis-ci.org"
    - git config user.name "Travis CI"
    - git remote set-url origin https://$GITHUB_TOKEN@github.com/ember-cli/ember-cli-update-codemods-manifest.git
    - git fetch
    - git branch -u origin/master
    - echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" >> ~/.npmrc
    - npm run release
